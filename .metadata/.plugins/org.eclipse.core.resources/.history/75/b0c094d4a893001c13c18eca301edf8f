package com.groupc.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;

import com.groupc.dto.AdminVO;
import com.groupc.dto.OrderVO;
import com.groupc.dto.ProductVO;
import com.groupc.util.Dbm;
import com.groupc.util.Paging;

public class AdminDao {
	private AdminDao() {}
	private static AdminDao itc = new AdminDao();
	public static AdminDao getInstance() {return itc;}
	
	Connection con = null;
	PreparedStatement pstmt = null;
	ResultSet rs = null;
	
	public AdminVO getWorker(String adminId) {
		AdminVO avo = null;
		String sql = "SELECT * FROM worker WHERE id=?";
		con = Dbm.getConnection();
		try {
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, adminId);
			rs = pstmt.executeQuery();
			if( rs.next() ) {
				avo = new AdminVO();
				avo.setId( rs.getString("id") );
				avo.setPwd(rs.getString("pwd"));
				avo.setName(rs.getString("name"));
				avo.setPhone(rs.getString("phone"));
			}
		} catch (SQLException e) { e.printStackTrace();
		} finally { Dbm.close(con, pstmt, rs);
		}
		return avo;
	}

	public ArrayList<Integer> getCnt() {
		ArrayList<Integer> cnt = new ArrayList<Integer>();
		String sql = "";
		con = Dbm.getConnection();
		try {
			// membercnt
			sql = "SELECT COUNT(*) AS membercnt FROM member WHERE useyn='y'";
			pstmt = con.prepareStatement(sql);
			rs = pstmt.executeQuery();
			if(rs.next()) {
				int i = rs.getInt("membercnt");
				cnt.add(0, i);
			}
			pstmt.close();
			
			// bookcnt
			sql = "SELECT COUNT(*) AS bookcnt FROM bookproduct WHERE useyn='y'";
			pstmt = con.prepareStatement(sql);
			rs = pstmt.executeQuery();
			if(rs.next()) {
				int i = rs.getInt("bookcnt");
				cnt.add(1, i);
			}
			pstmt.close();
			
			// ordercnt
			sql = "SELECT COUNT(*) AS ordercnt FROM orders";
			pstmt = con.prepareStatement(sql);
			rs = pstmt.executeQuery();
			if(rs.next()) {
				int i = rs.getInt("ordercnt");
				cnt.add(2, i);
			}
			pstmt.close();

			// qnacnt
			sql = "SELECT COUNT(*) AS qnacnt FROM qna";
			pstmt = con.prepareStatement(sql);
			rs = pstmt.executeQuery();
			if(rs.next()) {
				int i = rs.getInt("qnacnt");
				cnt.add(3, i);
			}
			
		} catch (SQLException e) { e.printStackTrace();
		} finally { Dbm.close(con, pstmt, rs);
		}
		
		return cnt;
	}

	public int getAdminCount(String tablename, String fieldname, String key) {
		int count = 0;
		String sql = "SELECT COUNT(*) AS count FROM " + tablename + " WHERE " + 
		fieldname + " LIKE '%'||?||'%' ";
		con = Dbm.getConnection();
		try {
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, key);
			rs = pstmt.executeQuery();
			if(rs.next()) {
				count = rs.getInt("count");
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}finally {
			Dbm.close(con, pstmt, rs);
		}
		return count;
	}

	public ArrayList<ProductVO> getProductList(Paging paging, String key) {
		ArrayList<ProductVO> productList = new ArrayList<ProductVO>();
		
		String sql = "SELECT * FROM (" + " SELECT * FROM ( "
						+ " SELECT rownum AS rn, b.* FROM ("
						+ " (SELECT * FROM bookproduct WHERE bname LIKE '%'||?||'%' ORDER BY bseq DESC) b) "
						+ " ) WHERE rn >= ? " + " ) WHERE rn <= ? ";
		
		con = Dbm.getConnection();
		try {
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, key);
			pstmt.setInt(2, paging.getStartNum());
			pstmt.setInt(3, paging.getEndNum());
			rs = pstmt.executeQuery();
			while(rs.next()) {
				ProductVO pvo = new ProductVO();
				pvo.setBseq(rs.getInt("bseq"));
				pvo.setBname(rs.getString("bname"));
				pvo.setWriter(rs.getString("writer"));
				pvo.setByear(rs.getString("byear"));
				pvo.setKind(rs.getString("kind"));
				pvo.setPrice(rs.getInt("price"));
				pvo.setPublisher(rs.getString("publisher"));
				pvo.setGenre(rs.getString("genre"));
				pvo.setContent(rs.getString("content"));
				pvo.setImage(rs.getString("image"));
				pvo.setUseyn(rs.getString("useyn"));
				pvo.setBestyn(rs.getString("bestyn"));
				pvo.setIndate(rs.getTimestamp("indate"));
				productList.add(pvo);
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}finally {
			Dbm.close(con, pstmt, rs);
		}
		
		
		return productList;
	}

	public void updateProduct(ProductVO pvo) {
		String sql = "UPDATE bookproduct SET bname=?, writer=?, byear=?, kind=?, "
				+ "price=?, publisher=?, genre=?, content=?, useyn=?, bestyn=?, image=? "
				+ "WHERE bseq=?";
		con = Dbm.getConnection();
		try {
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, pvo.getBname());
			pstmt.setString(2, pvo.getWriter());
			pstmt.setString(3, pvo.getByear());
			pstmt.setString(4, pvo.getKind());
			pstmt.setInt(5, pvo.getPrice());
			pstmt.setString(6, pvo.getPublisher());
			pstmt.setString(7, pvo.getGenre());
			pstmt.setString(8, pvo.getContent());
			pstmt.setString(9, pvo.getUseyn());
			pstmt.setString(10, pvo.getBestyn());
			pstmt.setString(11, pvo.getImage());
			pstmt.setInt(12, pvo.getBseq());
			pstmt.executeUpdate();
		} catch (SQLException e) {
			e.printStackTrace();
		}finally {
			Dbm.close(con, pstmt, rs);
		}
	}

	public void insertProduct(ProductVO pvo) {
		String sql = "INSERT INTO bookproduct(bseq, bname, writer, publisher, byear, price, content, kind, genre, image, bestyn, useyn) "
				+ " VALUES(bookproduct_seq.nextVal, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
		con = Dbm.getConnection();
		try {
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, pvo.getBname());
			pstmt.setString(2, pvo.getWriter());
			pstmt.setString(3, pvo.getPublisher());
			pstmt.setString(4, pvo.getByear());
			pstmt.setInt(5, pvo.getPrice());
			pstmt.setString(6, pvo.getContent());
			pstmt.setString(7, pvo.getKind());
			pstmt.setString(8, pvo.getGenre());
			pstmt.setString(9, pvo.getImage());
			pstmt.setString(10, pvo.getBestyn());
			pstmt.setString(11, pvo.getUseyn());
			pstmt.executeUpdate();
		} catch (SQLException e) {
			e.printStackTrace();
		}finally {
			Dbm.close(con, pstmt, rs);
		}
	}

	public void deleteProduct(int bseq) {
		String sql = "DELETE FROM bookproduct WHERE bseq =?";
		con = Dbm.getConnection();
		try {
			pstmt = con.prepareStatement(sql);
			pstmt.setInt(1, bseq);
			pstmt.executeUpdate();
		} catch (SQLException e) {
			e.printStackTrace();
		}finally {
			Dbm.close(con, pstmt, rs);
		}
		
	}

	public ArrayList<OrderVO> listOrder(Paging paging, String key) {
		ArrayList<OrderVO> list = new ArrayList<OrderVO>();
		String sql = "select * from ("
				+ " select * from ("
				+ " select rownum as rn, m.* from "
				+ " ((select * from order_view where mname like '%'||?||'%' order by result, odseq desc) m)"
				+ " ) where rn>=?"
				+ " ) where rn<=?";
		
		con = Dbm.getConnection();
		
		try {
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, key);
			pstmt.setInt(2, paging.getStartNum());
			pstmt.setInt(3, paging.getEndNum());
			rs = pstmt.executeQuery();
			while(rs.next()) {	// 리스트의 내용을 소진할때까지
				OrderVO ovo = new OrderVO();
				ovo.setOdseq(rs.getInt("odseq"));
				ovo.setOseq(rs.getInt("oseq"));
				ovo.setId(rs.getString("id"));
				ovo.setIndate(rs.getTimestamp("indate"));
				ovo.setMname(rs.getString("mname"));
				ovo.setZip_num(rs.getString("zip_num"));
				ovo.setAddress(rs.getString("address"));
				ovo.setPhone(rs.getString("phone"));
				ovo.setBseq(rs.getInt("bseq"));
				ovo.setQuantity(rs.getInt("quantity"));
				ovo.setBname(rs.getString("bname"));
				ovo.setPrice(rs.getInt("price"));
				ovo.setResult(rs.getString("result"));
				list.add(ovo);
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}finally {
			Dbm.close(con, pstmt, rs);
		}
		return list;
	}

	public void changeResult(int odseq, int result) {
		String sql = "update order_detail set result=? where odseq=?";
		
		con = Dbm.getConnection();
		try {
			pstmt = con.prepareStatement(sql);
			pstmt.setInt(1, result);
			pstmt.setInt(2, odseq);
			pstmt.executeUpdate();
		} catch (SQLException e) {
			e.printStackTrace();
		}finally {
			Dbm.close(con, pstmt, rs);
		}
	}

	public int getOrderCount(String tablename, String fieldname, String key, int i) {
		int count = 0;
		String sql = "";
		if(i==1) {	// result가 1,2,3인 목록들만...
			sql = "SELECT COUNT(*) AS count FROM " + tablename + " WHERE (result=1 OR result=2 OR result=3) and " + 
					fieldname + " LIKE '%'||?||'%' ";
		}else if(i==2) {
			sql = "SELECT COUNT(*) AS count FROM " + tablename + " WHERE (result=4 OR result=5) and " + 
					fieldname + " LIKE '%'||?||'%' ";
		}else if(i==3) {
			sql = "SELECT COUNT(*) AS count FROM " + tablename + " WHERE (result=1 OR result=2 OR result=3) and " + 
					fieldname + " LIKE '%'||?||'%' ";
		}else if(i==4) {
			sql = "SELECT COUNT(*) AS count FROM " + tablename + " WHERE (result=4 OR result=5) and " + 
					fieldname + " LIKE '%'||?||'%' ";
		}
		
//		sql = "SELECT COUNT(*) AS count FROM " + tablename + " WHERE " + 
//				fieldname + " LIKE '%'||?||'%' ";
		con = Dbm.getConnection();
		try {
			pstmt = con.prepareStatement(sql);
			pstmt.setString(1, key);
			rs = pstmt.executeQuery();
			if(rs.next()) {
				count = rs.getInt("count");
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}finally {
			Dbm.close(con, pstmt, rs);
		}
		return count;
	}
	

	
	
}
